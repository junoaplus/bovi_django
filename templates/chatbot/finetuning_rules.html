{% extends 'chatbot/base.html' %}

{% block title %}íŒŒì¸íŠœë‹ ë£° ì„¤ëª… - ë³´ë“œê²Œì„ ì±„íŒ…ë´‡{% endblock %}

{% block content %}
<div class="rule-container">
    <div class="game-selector">
        <h2>âš™ï¸ ê²Œì„ ì„ íƒ (ì „ë¬¸ AI)</h2>
        
        <!-- ê²€ìƒ‰ì°½ ì¶”ê°€ -->
        <div class="game-search-container">
            <input type="text" id="gameSearch" class="game-search" placeholder="ê²Œì„ ì´ë¦„ì„ ê²€ìƒ‰í•˜ì„¸ìš”... (ì˜ˆ: ë±…, ì¹´íƒ„, ìŠ¤í”Œë Œë”)">
            <div class="search-icon">ğŸ”</div>
        </div>
        
        <!-- ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ -->
        <div id="searchResults" class="search-results" style="display: none;"></div>
        
        <!-- ê¸°ì¡´ ë“œë¡­ë‹¤ìš´ -->
        <div class="dropdown-container">
            <select id="gameSelect" class="game-dropdown">
                <option value="">ë˜ëŠ” ìŠ¤í¬ë¡¤í•´ì„œ ê²Œì„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                {% for game in available_games %}
                    <option value="{{ game }}">{{ game }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    
    <div class="rule-summary" id="ruleSummary" style="display: none;">
        <h3>ğŸ¯ ì „ë¬¸ AIì˜ ì •í™•í•œ ë£° ì„¤ëª…</h3>
        <div id="summaryContent" class="summary-content"></div>
    </div>
    
    <div class="chat-container" id="chatContainer" style="display: none;">
        <div class="chat-header">
            <h1>âš™ï¸ íŒŒì¸íŠœë‹ ë£° ì„¤ëª… ì±—ë´‡</h1>
            <p id="selectedGameName"></p>
            <small style="opacity: 0.8;">ì „ë¬¸ì ìœ¼ë¡œ í•™ìŠµëœ AIê°€ ë”ìš± ì •í™•í•œ ë£° ì„¤ëª…ì„ ì œê³µí•©ë‹ˆë‹¤</small>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-bubble">
                    ê²Œì„ì„ ì„ íƒí•˜ì‹  í›„ ë³µì¡í•œ ë£°ì´ë‚˜ ì˜ˆì™¸ ìƒí™©ì— ëŒ€í•´ ì§ˆë¬¸í•´ì£¼ì„¸ìš”! âš™ï¸<br>
                    ì „ë¬¸ì ìœ¼ë¡œ í•™ìŠµëœ AIê°€ ì •í™•í•˜ê³  ìƒì„¸í•œ ë‹µë³€ì„ ì œê³µí•©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="ì „ë¬¸ì ì¸ ë£° ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”..." maxlength="500">
                <button onclick="sendMessage()">ì „ì†¡</button>
            </div>
        </div>
    </div>
</div>

<div class="qr-container">
    <h3 style="color: white; margin-bottom: 1rem;">ğŸ“± ëª¨ë°”ì¼ì—ì„œ ì±„íŒ…í•˜ê¸°</h3>
    <p style="color: white; margin-bottom: 1rem;">QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ í•¸ë“œí°ì—ì„œ ë¹„ë°€ìŠ¤ëŸ½ê²Œ ì§ˆë¬¸í•˜ì„¸ìš”!</p>
    <div class="qr-code">
        <img src="{% url 'chatbot:generate_qr' 'finetuning_rules' %}" alt="íŒŒì¸íŠœë‹ ë£° ì„¤ëª… QR ì½”ë“œ" style="width: 200px; height: 200px;">
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.rule-container {
    max-width: 1000px;
    margin: 0 auto;
}

.game-selector {
    background: rgba(255, 255, 255, 0.95);
    padding: 2rem;
    border-radius: 15px;
    margin-bottom: 2rem;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border: 2px solid #7c3aed;
}

.game-selector h2 {
    color: #7c3aed;
    margin-bottom: 1.5rem;
    text-align: center;
}

/* ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ */
.game-search-container {
    position: relative;
    margin-bottom: 1rem;
}

.game-search {
    width: 100%;
    padding: 1rem 3rem 1rem 1rem;
    font-size: 1.1rem;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    background: white;
    outline: none;
    transition: all 0.3s ease;
}

.game-search:focus {
    border-color: #7c3aed;
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
}

.search-icon {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
    pointer-events: none;
}

/* ê²€ìƒ‰ ê²°ê³¼ ìŠ¤íƒ€ì¼ */
.search-results {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    margin-bottom: 1rem;
    max-height: 200px;
    overflow-y: auto;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.search-result-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f1f5f9;
    transition: background-color 0.2s ease;
}

.search-result-item:hover {
    background-color: #f8fafc;
}

.search-result-item:last-child {
    border-bottom: none;
}

.search-result-item.selected {
    background-color: #7c3aed;
    color: white;
}

.no-results {
    padding: 1rem;
    text-align: center;
    color: #666;
    font-style: italic;
}

/* ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
.dropdown-container {
    margin-top: 1rem;
}

.game-dropdown {
    width: 100%;
    padding: 1rem;
    font-size: 1.1rem;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    background: white;
    outline: none;
    transition: border-color 0.3s ease;
}

.game-dropdown:focus {
    border-color: #7c3aed;
}

.rule-summary {
    background: rgba(255, 255, 255, 0.95);
    padding: 2rem;
    border-radius: 15px;
    margin-bottom: 2rem;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border: 2px solid #7c3aed;
}

.rule-summary h3 {
    color: #7c3aed;
    margin-bottom: 1rem;
}

.summary-content {
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap;
}

.chat-container {
    margin-bottom: 2rem;
}

.chat-header {
    background: linear-gradient(45deg, #7c3aed, #a855f7);
}

.loading {
    text-align: center;
    color: #666;
    font-style: italic;
}

/* íŒŒì¸íŠœë‹ ë²„ì „ë§Œì˜ íŠ¹ë³„í•œ ìŠ¤íƒ€ì¼ */
.message.bot .message-bubble {
    background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
    border-left: 4px solid #7c3aed;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let sessionId = null;
let selectedGame = '';
let allGames = [{% for game in available_games %}'{{ game|escapejs }}'{% if not forloop.last %}, {% endif %}{% endfor %}];

// ê²Œì„ ê²€ìƒ‰ ê¸°ëŠ¥
document.getElementById('gameSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    const searchResults = document.getElementById('searchResults');
    
    if (searchTerm === '') {
        searchResults.style.display = 'none';
        return;
    }
    
    // ê²€ìƒ‰ ê²°ê³¼ í•„í„°ë§
    const filteredGames = allGames.filter(game => 
        game.toLowerCase().includes(searchTerm)
    );
    
    if (filteredGames.length > 0) {
        let resultsHTML = '';
        filteredGames.slice(0, 10).forEach(game => { // ìµœëŒ€ 10ê°œê¹Œì§€ë§Œ í‘œì‹œ
            resultsHTML += `<div class="search-result-item" onclick="selectGameFromSearch('${game.replace(/'/g, "\\'")}')">âš™ï¸ ${game}</div>`;
        });
        searchResults.innerHTML = resultsHTML;
        searchResults.style.display = 'block';
    } else {
        searchResults.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</div>';
        searchResults.style.display = 'block';
    }
});

// ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ê²Œì„ ì„ íƒ
function selectGameFromSearch(gameName) {
    selectedGame = gameName;
    document.getElementById('gameSearch').value = gameName;
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('gameSelect').value = gameName;
    
    // ê²Œì„ ì„ íƒ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
    loadGameAndSetupChat(gameName);
}

// ê²Œì„ ë¡œë“œ ë° ì±„íŒ… ì„¤ì • (ê³µí†µ í•¨ìˆ˜)
function loadGameAndSetupChat(gameName) {
    selectedGame = gameName;
    loadGameRuleSummary(gameName);
    document.getElementById('selectedGameName').textContent = `ì„ íƒëœ ê²Œì„: ${gameName}`;
    document.getElementById('chatContainer').style.display = 'block';
    
    // ì±„íŒ… ë©”ì‹œì§€ ì´ˆê¸°í™”
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = `
        <div class="message bot">
            <div class="message-bubble">
                ${gameName} ê²Œì„ì˜ ì „ë¬¸ ë£° ì„¤ëª…ì„ í™•ì¸í•˜ì…¨ë‚˜ìš”? âš™ï¸<br>
                ë³µì¡í•œ ìƒí™©ì´ë‚˜ ì˜ˆì™¸ ê·œì¹™ì— ëŒ€í•´ ì •í™•í•œ ë‹µë³€ì„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤!
            </div>
        </div>
    `;
}

// ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
document.addEventListener('click', function(e) {
    const searchContainer = document.querySelector('.game-search-container');
    const searchResults = document.getElementById('searchResults');
    
    if (!searchContainer.contains(e.target)) {
        searchResults.style.display = 'none';
    }
});

// ê¸°ì¡´ ë“œë¡­ë‹¤ìš´ ê²Œì„ ì„ íƒ ì‹œ ë£° ìš”ì•½ ë¡œë“œ
document.getElementById('gameSelect').addEventListener('change', function() {
    if (this.value) {
        // ê²€ìƒ‰ì°½ë„ ì—…ë°ì´íŠ¸
        document.getElementById('gameSearch').value = this.value;
        loadGameAndSetupChat(this.value);
    } else {
        selectedGame = '';
        document.getElementById('gameSearch').value = '';
        document.getElementById('ruleSummary').style.display = 'none';
        document.getElementById('chatContainer').style.display = 'none';
    }
});

function loadGameRuleSummary(gameName) {
    const summaryDiv = document.getElementById('ruleSummary');
    const contentDiv = document.getElementById('summaryContent');
    
    // ë¡œë”© í‘œì‹œ
    contentDiv.innerHTML = '<div class="loading">ì „ë¬¸ AIê°€ ë£°ì„ ë¶„ì„í•˜ëŠ” ì¤‘...</div>';
    summaryDiv.style.display = 'block';
    
    fetch('{% url "chatbot:rule_summary_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            game_name: gameName,
            chat_type: 'finetuning_rules'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            contentDiv.innerHTML = data.summary.replace(/\n/g, '<br>');
        } else {
            contentDiv.innerHTML = 'ë£° ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        contentDiv.innerHTML = 'ë£° ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    });
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message || !selectedGame) {
        if (!selectedGame) {
            alert('ë¨¼ì € ê²Œì„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        }
        return;
    }
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
    addMessage(message, 'user');
    input.value = '';
    
    // ë´‡ ì‘ë‹µ ìš”ì²­
    fetch('{% url "chatbot:chat_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            chat_type: 'finetuning_rules',
            session_id: sessionId,
            game_name: selectedGame
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            addMessage(data.response, 'bot');
            sessionId = data.session_id;
        } else {
            addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'bot');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'bot');
    });
}

function addMessage(message, sender) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'message-bubble';
    bubbleDiv.innerHTML = message.replace(/\n/g, '<br>');
    
    messageDiv.appendChild(bubbleDiv);
    chatMessages.appendChild(messageDiv);
    
    // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// ì—”í„° í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„° í™•ì¸
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const gameParam = urlParams.get('game');
    
    if (gameParam && allGames.includes(gameParam)) {
        // URL íŒŒë¼ë¯¸í„°ë¡œ ê²Œì„ì´ ì§€ì •ëœ ê²½ìš° ìë™ ì„ íƒ
        document.getElementById('gameSearch').value = gameParam;
        document.getElementById('gameSelect').value = gameParam;
        loadGameAndSetupChat(gameParam);
    }
});
</script>
{% endblock %}
